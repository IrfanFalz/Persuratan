<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Surat;
use App\Models\Notifikasi;

class DashboardGuruController extends Controller
{
    public function index()
    {
        $userId = auth()->id();

        $letter_requests = Surat::with([
                'persetujuan',
                'pengguna',
                'suratDispensasi.detail',
                'suratPerintahTugas.detail'
            ])
            ->where('id_pengguna', $userId)
            ->orderBy('dibuat_pada', 'desc')
            ->get()
            ->map(function ($surat) {
           
                switch ($surat->status_berkas) {
                    case 'disetujui':
                        $status = 'approved';
                        break;
                    case 'ditolak':
                        $status = 'rejected';
                        break;
                    case 'diproses':
                        $status = 'processing';
                        break;
                    default:
                        $status = 'pending';
                }

                $guruData = [];
                if ($surat->suratDispensasi) {
                    $guruData = $surat->suratDispensasi->detail->map(function ($d) {
                        return [
                            'nama'       => $d->nama ?? $d->nama_siswa ?? '-',
                            'nip'        => $d->nip ?? '-',
                            'keterangan' => $d->keterangan ?? '-',
                        ];
                    })->toArray();
                } elseif ($surat->suratPerintahTugas) {
                    $guruData = $surat->suratPerintahTugas->detail->map(function ($d) {
                        return [
                            'nama'       => $d->nama_guru ?? '-',
                            'nip'        => $d->nip ?? '-',
                            'keterangan' => $d->keterangan ?? '-',
                        ];
                    })->toArray();
                }

                return [
                    'id'              => $surat->id_surat,  
                    'type'            => $surat->suratDispensasi ? 'Surat Dispensasi' : 'Surat Perintah Tugas',
                    'date'            => $surat->dibuat_pada ?? now(),
                    'status'          => $status,
                    'approved_by'     => $surat->persetujuan->id_pengguna ?? null,
                    'processed_by_tu' => $status === 'approved',

                    'keperluan'       => $surat->suratDispensasi->keperluan
                                            ?? $surat->suratPerintahTugas->keperluan
                                            ?? '-',
                    'hari'            => $surat->suratDispensasi->hari
                                            ?? $surat->suratPerintahTugas->hari
                                            ?? '-',
                    'tanggal'         => $surat->suratDispensasi->tanggal
                                            ?? $surat->suratPerintahTugas->tanggal
                                            ?? '-',
                    'jam'             => $surat->suratDispensasi->jam
                                            ?? $surat->suratPerintahTugas->jam
                                            ?? '-',
                    'tempat'          => $surat->suratDispensasi->tempat
                                            ?? $surat->suratPerintahTugas->tempat
                                            ?? '-',

                    'pemohon'         => [
                        'nama' => $surat->pengguna->nama ?? '-',
                        'telp' => $surat->pengguna->no_telp ?? '-',
                        'nip'  => $surat->pengguna->nip ?? '-',
                    ],

                    'guru_data'       => $guruData
                ];
            });

        $approvedCount = $letter_requests->where('status', 'approved')->count();
        $pendingCount  = $letter_requests->where('status', 'pending')->count();
        $rejectedCount = $letter_requests->where('status', 'rejected')->count();
        $processingCount = $letter_requests->where('status', 'processing')->count();
        $totalCount    = $letter_requests->count();

        $notifikasi = Notifikasi::where('id_pengguna', $userId)
            ->latest('created_at')
            ->take(5)
            ->get();

        $letter_types = [
            'surat-perintah-tugas' => 'Surat Perintah Tugas',
            'surat-dispensasi'     => 'Surat Dispensasi',
        ];

        return view('dashboard-guru', compact(
            'letter_requests',
            'letter_types',
            'notifikasi',
            'approvedCount',
            'pendingCount',
            'rejectedCount',
            'processingCount',
            'totalCount'
        ));
    }
}
